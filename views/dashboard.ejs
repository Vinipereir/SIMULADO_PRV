<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Cantina</title>
    <link rel="stylesheet" href="/base.css">
    <link rel="stylesheet" href="/dashboard.css">
</head>
<body>
    <div class="container">
        <div class="nav">
            <a href="/dashboard">Dashboard</a>
            <% if (usuario.tipo === 'admin') { %>
                <a href="/cadastro-produto">Cadastrar Produto</a>
                <a href="/gestao-estoque">Gest√£o de Estoque</a>
            <% } %>
            <a href="/logout">Sair</a>
        </div>

        <h1>Bem-vindo(a) √† Cantina, <%= usuario.nome %>! ü•™</h1>

        <h2>Card√°pio de Comidas</h2>
    <form method="GET" action="/dashboard">
        <input type="text" name="busca" placeholder="Buscar comida por nome" value="<%= busca %>"/>
        <button type="submit">Buscar</button>
    </form>

    <% if (usuario.tipo === 'admin') { %>
        <h3>Cadastrar Comida</h3>
        <form method="POST" action="/foods">
            <input type="text" name="name" placeholder="Nome da Comida" required />
            <input type="text" name="descricao" placeholder="Descri√ß√£o" />
            <input type="number" name="preco" placeholder="Pre√ßo" step="0.01" required />
            <input type="number" name="estoque" placeholder="Estoque inicial" required />
            <button type="submit">Cadastrar Comida</button>
        </form>
    <% } %>

    <h3>Lista de Comidas</h3>
    <ul>
        <% foods.forEach(function(food) { %>
            <li>
                <div class="produto-info">
                    <strong><%= food.name %></strong>
                    <span>R$ <%= parseFloat(food.preco).toFixed(2) %> ‚Ä¢ Estoque: <%= food.estoque %></span>
                </div>
                <div class="produto-acoes">
                    <% if (usuario.tipo === 'admin') { %>
                        <button type="button" 
                                class="edit"
                                data-id="<%= food.id %>" 
                                data-nome="<%= food.name %>" 
                                data-descricao="<%= food.descricao || '' %>" 
                                data-preco="<%= food.preco %>" 
                                data-estoque="<%= food.estoque %>"
                                onclick="editarComida(this)">Editar</button>
                        <form method="POST" action="/foods/delete/<%= food.id %>">
                            <button type="submit" class="delete" onclick="return confirm('Tem certeza que deseja excluir esta comida?')">Excluir</button>
                        </form>
                    <% } else { %>
                        <form method="POST" action="/pedidos">
                            <input type="hidden" name="food_id" value="<%= food.id %>">
                            <input type="number" name="quantidade" min="1" max="<%= food.estoque %>" value="1">
                            <button type="submit" <%= food.estoque === 0 ? 'disabled' : '' %>>Pedir</button>
                        </form>
                    <% } %>
                </div>
            </li>
        <% }); %>
    </ul>

    <% if (usuario.tipo === 'admin') { %>
        <!-- Modal de Edi√ß√£o -->
        <div id="modalEditarComida" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border:2px solid #333; z-index:1000;">
            <h3>Editar Comida</h3>
            <form id="formEditarComida" method="POST">
                <input type="text" id="editName" name="name" placeholder="Nome da Comida" required /><br><br>
                <input type="text" id="editDescricao" name="descricao" placeholder="Descri√ß√£o" /><br><br>
                <input type="number" id="editPreco" name="preco" placeholder="Pre√ßo" step="0.01" required /><br><br>
                <input type="number" id="editEstoque" name="estoque" placeholder="Estoque" required /><br><br>
                <button type="submit">Salvar Altera√ß√µes</button>
                <button type="button" onclick="fecharModal()">Cancelar</button>
            </form>
        </div>
        <div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;" onclick="fecharModal()"></div>

        <script>
            function editarComida(btn) {
                const id = btn.dataset.id;
                const nome = btn.dataset.nome;
                const descricao = btn.dataset.descricao;
                const preco = btn.dataset.preco;
                const estoque = btn.dataset.estoque;
                
                document.getElementById('editName').value = nome;
                document.getElementById('editDescricao').value = descricao;
                document.getElementById('editPreco').value = preco;
                document.getElementById('editEstoque').value = estoque;
                document.getElementById('formEditarComida').action = '/foods/update/' + id;
                document.getElementById('modalEditarComida').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            }

            function fecharModal() {
                document.getElementById('modalEditarComida').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
            }
        </script>

        <h3>Hist√≥rico de Pedidos</h3>
        <table border="1" style="width:100%; text-align:left;">
            <thead>
                <tr>
                    <th>ID Pedido</th>
                    <th>Usu√°rio</th>
                    <th>Comida</th>
                    <th>Quantidade</th>
                    <th>Data</th>
                </tr>
            </thead>
            <tbody>
                <% pedidos.forEach(function(pedido) { %>
                    <tr>
                        <td><%= pedido.id %></td>
                        <td><%= pedido.usuario %></td>
                        <td><%= pedido.comida %></td>
                        <td><%= pedido.quantidade %></td>
                        <td><%= pedido.data %></td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    <% } %>
    
</body>
</html>